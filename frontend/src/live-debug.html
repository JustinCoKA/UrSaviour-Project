<!DOCTYPE html>
<html>
<head>
    <title>LIVE DEBUG - UrSaviour Data Flow</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #222; }
        pre { background: #000; padding: 10px; overflow: auto; max-height: 300px; color: #0f0; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        button { background: #333; color: #0f0; border: 1px solid #555; padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #555; }
        .step { margin: 10px 0; padding: 10px; background: #111; border-left: 3px solid #0f0; }
    </style>
</head>
<body>
    <h1>üîç LIVE DEBUG: UrSaviour Data Flow</h1>
    
    <div class="section">
        <h2>Step 1: API Raw Response</h2>
        <button onclick="testStep1()">üîç Test API Response</button>
        <div id="step1-result"></div>
    </div>

    <div class="section">
        <h2>Step 2: Products Array Extraction</h2>
        <button onclick="testStep2()">üîß Test Data Extraction</button>
        <div id="step2-result"></div>
    </div>

    <div class="section">
        <h2>Step 3: Normalization Process</h2>
        <button onclick="testStep3()">‚öôÔ∏è Test Normalization</button>
        <div id="step3-result"></div>
    </div>

    <div class="section">
        <h2>Step 4: Final Display Format</h2>
        <button onclick="testStep4()">üéØ Test Final Output</button>
        <div id="step4-result"></div>
    </div>

    <div class="section">
        <h2>üö® Live Console Capture</h2>
        <div id="console-output"></div>
    </div>

    <script>
        // Global variables to store test data
        let rawApiData = null;
        let extractedProducts = null;
        let normalizedProducts = null;

        // Console capture
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        let consoleCapture = [];
        
        function captureConsole() {
            console.log = function(...args) {
                consoleCapture.push({type: 'log', message: args.join(' ')});
                originalLog.apply(console, args);
                updateConsoleDisplay();
            };
            
            console.warn = function(...args) {
                consoleCapture.push({type: 'warn', message: args.join(' ')});
                originalWarn.apply(console, args);
                updateConsoleDisplay();
            };
            
            console.error = function(...args) {
                consoleCapture.push({type: 'error', message: args.join(' ')});
                originalError.apply(console, args);
                updateConsoleDisplay();
            };
        }
        
        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-output');
            const recentLogs = consoleCapture.slice(-10);
            consoleDiv.innerHTML = recentLogs.map(log => 
                `<div class="${log.type}">[${log.type.toUpperCase()}] ${log.message}</div>`
            ).join('');
        }

        // Start console capture
        captureConsole();

        async function testStep1() {
            const resultDiv = document.getElementById('step1-result');
            resultDiv.innerHTML = '<div class="warning">Testing API...</div>';
            
            try {
                console.log('=== STEP 1: API RAW RESPONSE TEST ===');
                const response = await fetch('/api/v1/products/?limit=3');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                rawApiData = await response.json();
                console.log('Raw API Data Type:', typeof rawApiData);
                console.log('Raw API Data Keys:', Object.keys(rawApiData));
                console.log('Has products key:', rawApiData.hasOwnProperty('products'));
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ API Response Success</div>
                    <div class="step">
                        <strong>Response Type:</strong> ${typeof rawApiData}<br>
                        <strong>Keys:</strong> ${Object.keys(rawApiData).join(', ')}<br>
                        <strong>Has 'products':</strong> ${rawApiData.hasOwnProperty('products')}<br>
                        <strong>Products Count:</strong> ${rawApiData.products ? rawApiData.products.length : 'N/A'}
                    </div>
                    <pre>${JSON.stringify(rawApiData, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Step 1 Error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå API Error: ${error.message}</div>`;
            }
        }

        async function testStep2() {
            const resultDiv = document.getElementById('step2-result');
            
            if (!rawApiData) {
                resultDiv.innerHTML = '<div class="error">‚ùå Run Step 1 first!</div>';
                return;
            }
            
            try {
                console.log('=== STEP 2: PRODUCTS ARRAY EXTRACTION ===');
                
                // Simulate frontend extraction logic
                if (rawApiData && rawApiData.products && Array.isArray(rawApiData.products)) {
                    extractedProducts = rawApiData.products;
                    console.log('Extracted products array:', extractedProducts.length, 'items');
                } else if (Array.isArray(rawApiData)) {
                    extractedProducts = rawApiData;
                    console.log('Response is already array:', extractedProducts.length, 'items');
                } else {
                    throw new Error("API response missing 'products' array");
                }
                
                console.log('First extracted product:', extractedProducts[0]);
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Extraction Success</div>
                    <div class="step">
                        <strong>Extracted Count:</strong> ${extractedProducts.length}<br>
                        <strong>First Product ID:</strong> ${extractedProducts[0]?.productId}<br>
                        <strong>First Product Name:</strong> ${extractedProducts[0]?.productName}<br>
                        <strong>First Product Category:</strong> ${extractedProducts[0]?.categoryName}
                    </div>
                    <pre>${JSON.stringify(extractedProducts[0], null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Step 2 Error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Extraction Error: ${error.message}</div>`;
            }
        }

        async function testStep3() {
            const resultDiv = document.getElementById('step3-result');
            
            if (!extractedProducts) {
                resultDiv.innerHTML = '<div class="error">‚ùå Run Steps 1-2 first!</div>';
                return;
            }
            
            try {
                console.log('=== STEP 3: NORMALIZATION PROCESS ===');
                
                // Simulate the exact normalization logic from frontend
                const testProduct = extractedProducts[0];
                console.log('Normalizing product:', testProduct.productId, testProduct.productName);
                
                let processedStores = [];
                
                if (Array.isArray(testProduct.stores)) {
                    console.log('Processing stores array:', testProduct.stores.length, 'stores');
                    
                    processedStores = testProduct.stores.map((s, storeIdx) => {
                        console.log(`Store ${storeIdx} mapping:`, s.store_name, '‚Üí', s.final_price);
                        
                        return {
                            brand: s.store_name || s.brand || "Unknown Store",
                            price: Number(s.final_price || s.price || 0),
                            original_price: Number(s.original_price || s.basePrice || s.final_price || s.price || 0)
                        };
                    }).filter(s => {
                        const isValid = Number.isFinite(s.price);
                        if (!isValid) console.warn('Filtering out store with invalid price:', s);
                        return isValid;
                    });
                }
                
                const normalizedProduct = {
                    id: testProduct.productId || testProduct.id || 'MISSING_ID',
                    name: String(testProduct.productName || testProduct.name || "Unknown Product"),
                    category: testProduct.categoryName || testProduct.category || "Uncategorized",
                    description: testProduct.description || "",
                    image: testProduct.defaultImageUrl || testProduct.image || "",
                    stores: processedStores
                };
                
                console.log('Final normalized product:', normalizedProduct);
                
                normalizedProducts = [normalizedProduct];
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Normalization Success</div>
                    <div class="step">
                        <strong>Input Product Name:</strong> ${testProduct.productName}<br>
                        <strong>Output Product Name:</strong> ${normalizedProduct.name}<br>
                        <strong>Input Category:</strong> ${testProduct.categoryName}<br>
                        <strong>Output Category:</strong> ${normalizedProduct.category}<br>
                        <strong>Stores Processed:</strong> ${processedStores.length}<br>
                        <strong>First Store:</strong> ${processedStores[0]?.brand} - $${processedStores[0]?.price}
                    </div>
                    <pre>${JSON.stringify(normalizedProduct, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Step 3 Error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Normalization Error: ${error.message}</div>`;
            }
        }

        async function testStep4() {
            const resultDiv = document.getElementById('step4-result');
            
            if (!normalizedProducts) {
                resultDiv.innerHTML = '<div class="error">‚ùå Run Steps 1-3 first!</div>';
                return;
            }
            
            try {
                console.log('=== STEP 4: FINAL DISPLAY FORMAT ===');
                
                const product = normalizedProducts[0];
                
                // Simulate how the display renders this
                const displayName = product.name;
                const displayCategory = product.category;
                const displayPrice = product.stores[0]?.price || 0;
                const displayStore = product.stores[0]?.brand || "No Store";
                
                console.log('Display Values:', {displayName, displayCategory, displayPrice, displayStore});
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Final Display Test</div>
                    <div class="step">
                        <strong>Display Name:</strong> "${displayName}" ${displayName === "Unknown Product" ? "‚ùå PROBLEM!" : "‚úÖ GOOD"}<br>
                        <strong>Display Category:</strong> "${displayCategory}" ${displayCategory === "Uncategorized" ? "‚ùå PROBLEM!" : "‚úÖ GOOD"}<br>
                        <strong>Display Price:</strong> $${displayPrice} ${displayPrice === 0 ? "‚ùå PROBLEM!" : "‚úÖ GOOD"}<br>
                        <strong>Display Store:</strong> "${displayStore}" ${displayStore === "No Store" ? "‚ùå PROBLEM!" : "‚úÖ GOOD"}
                    </div>
                    
                    <h3>üéØ Root Cause Analysis:</h3>
                    <div style="background: #300; padding: 10px; border-left: 3px solid #f00;">
                        ${displayName === "Unknown Product" ? "üö® ISSUE: Product name is 'Unknown Product' - check field mapping!" : "‚úÖ Product name is correct"}
                    </div>
                `;
                
            } catch (error) {
                console.error('Step 4 Error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Display Test Error: ${error.message}</div>`;
            }
        }

        // Auto-run all tests on page load
        setTimeout(() => {
            console.log('üîç Starting automated debug sequence...');
            testStep1().then(() => {
                setTimeout(() => testStep2().then(() => {
                    setTimeout(() => testStep3().then(() => {
                        setTimeout(() => testStep4(), 1000);
                    }), 1000);
                }), 1000);
            });
        }, 1000);
    </script>
</body>
</html>